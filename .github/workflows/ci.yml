name: CI
run-name: >
  CI (${{ github.event_name }})
  ${{ github.event_name == 'pull_request' && format('PR#{0}', github.event.number) || '' }}

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ main ]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: üî® build
    uses: ./.github/workflows/step_build.yml

  upload-ero:
    name: ‚òÅÔ∏è upload .ero
    needs: [ build ]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: live-pocket-fedora
          path: mkosi.output/

      - name: Upload image.ero to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT_URL }}
        run: |
          stamp="$(date -u +%Y%m%d)"
          object_key="live-pocket-fedora/${stamp}.ero"
          aws s3api put-object \
            --bucket "${R2_BUCKET}" \
            --key "${object_key}" \
            --body "mkosi.output/image.ero" \
            --content-type "application/octet-stream" \
            --endpoint-url "${R2_ENDPOINT_URL}"

  pass:
    name: ‚úÖ Pass
    needs: [ build, upload-ero ]
    runs-on: ubuntu-latest
    steps:
      - uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}
    if: always()
