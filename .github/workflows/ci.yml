name: CI
run-name: >
  CI (${{ github.event_name }})
  ${{ github.event_name == 'pull_request' && format('PR#{0}', github.event.number) || '' }}

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ main ]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: üî® build
    uses: ./.github/workflows/step_build.yml
    secrets: inherit

  compose-coordinates:
    name: üì¶ compose coordinates
    needs: [ build ]
    runs-on: ubuntu-latest
    steps:
      - name: Report compose artifact coordinates
        run: |
          echo "compose_publish_enabled=${{ needs.build.outputs.compose_publish_enabled }}"
          echo "compose_manifest_s3=${{ needs.build.outputs.compose_manifest_s3 }}"
          echo "compose_manifest_url=${{ needs.build.outputs.compose_manifest_url }}"
          echo "compose_index_s3=${{ needs.build.outputs.compose_index_s3 }}"
          echo "compose_index_url=${{ needs.build.outputs.compose_index_url }}"
          echo "compose_chunk_prefix_s3=${{ needs.build.outputs.compose_chunk_prefix_s3 }}"
          echo "compose_chunk_prefix_url=${{ needs.build.outputs.compose_chunk_prefix_url }}"
          echo "compose_image_s3=${{ needs.build.outputs.compose_image_s3 }}"
          echo "compose_image_url=${{ needs.build.outputs.compose_image_url }}"
          echo "compose_new_chunk_bytes=${{ needs.build.outputs.compose_new_chunk_bytes }}"
          echo "compose_reused_chunk_bytes=${{ needs.build.outputs.compose_reused_chunk_bytes }}"
          echo "build_artifact_url=${{ needs.build.outputs.build_artifact_url }}"

          {
            echo "### Compose coordinates"
            echo ""
            echo "- publish enabled: \`${{ needs.build.outputs.compose_publish_enabled }}\`"
            echo "- manifest (s3): \`${{ needs.build.outputs.compose_manifest_s3 }}\`"
            echo "- manifest (url): \`${{ needs.build.outputs.compose_manifest_url }}\`"
            echo "- index (s3): \`${{ needs.build.outputs.compose_index_s3 }}\`"
            echo "- index (url): \`${{ needs.build.outputs.compose_index_url }}\`"
            echo "- chunk store (s3): \`${{ needs.build.outputs.compose_chunk_prefix_s3 }}\`"
            echo "- chunk store (url): \`${{ needs.build.outputs.compose_chunk_prefix_url }}\`"
            echo "- image (s3): \`${{ needs.build.outputs.compose_image_s3 }}\`"
            echo "- image (url): \`${{ needs.build.outputs.compose_image_url }}\`"
            echo "- dedupe bytes: new=${{ needs.build.outputs.compose_new_chunk_bytes }}, reused=${{ needs.build.outputs.compose_reused_chunk_bytes }}"
            echo "- gha artifact: \`${{ needs.build.outputs.build_artifact_url }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

  upload-ero:
    name: ‚òÅÔ∏è upload .ero
    needs: [ build ]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: live-pocket-fedora
          path: mkosi.output/

      - name: Upload live-pocket-fedora.ero to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT_URL }}
        run: |
          stamp="$(date -u +%Y%m%d)"
          object_key="live-pocket-fedora/${stamp}.ero"
          aws s3api put-object \
            --bucket "${R2_BUCKET}" \
            --key "${object_key}" \
            --body "mkosi.output/live-pocket-fedora.ero" \
            --content-type "application/octet-stream" \
            --endpoint-url "${R2_ENDPOINT_URL}"

  pass:
    name: ‚úÖ Pass
    needs: [ build, compose-coordinates ]
    runs-on: ubuntu-latest
    steps:
      - uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}
    if: always()
